{% extends "base.html" %}

{% block title %}Agendamento de Pacientes{% endblock %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Consultas</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FullCalendar CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" rel="stylesheet">

    <!-- FullCalendar Locale -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/lang/pt-br.js"></script>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='styleagenda.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
   
</head>
<body>

<div class="container">
    <div class="row">
        <!-- Coluna 1: Filtros e Calendário -->
        <div class="col-md-4 filtro">
            <h2>Filtrar Agendamento</h2>
          
    
            <label for="especialidade">Especialidade:</label>
            <select id="especialidade" name="especialidade" class="form-control" required>
                <option value="" disabled selected>Selecione a especialidade</option>
                    {% for especialidade in especialidades %}
                        <option value="{{ especialidade.codespecialidade }}">{{ especialidade.descricao }}</option>
                    {% endfor %}
            </select>
            
            <label for="medico" class="mt-3">Médico:</label>
            <select id="medico" name="medico" class="form-control" required>
                <option value="" disabled selected>Selecione um médico</option>
            </select>
            
        
              
            </select>
            <br>
            <button type="button" id="btnPesquisarescala" class="btn btn-primary">Pesquisar</button>  
            <div id="calendar" class="mt-4" style="display: none;"></div>
           
        </div>
       
            <!-- Coluna 2: Exibição de Horários -->
            <div class="col-md-4 horarios">
                <h2>Horários Disponíveis</h2>
                
                <!-- Grupo de Botões -->
                <!-- Grupo de Botões -->
                <!-- Grupo de Botões -->
                <div class="btn-group mb-3" role="group" aria-label="Horários">
                    <div>
                        <button type="button" id ="btnManha" class="btn btn-primary col">Manhã</button>
                        <input type="text" id="vagasManha" class="form-control text-center"disabled>
                    </div>
                    <div>
                        <button type="button" id="btnTarde" class="btn btn-primary col">Tarde</button>
                        <input type="text" id="vagasTarde" class="form-control text-center"disabled>
                    </div>
                    <div>
                        <button type="button" id="btnNoite" class="btn btn-primary col">Noite</button>
                        <input type="text" id="vagasNoite" class="form-control text-center" disabled>
                    </div>
                </div>
            
            
                <div id="horarios" class="mt-3">
                    <!-- Os horários serão preenchidos aqui -->
                    <ul class="list-group" id="listaHorarios">
                        <!-- Os horários serão preenchidos aqui -->
                    </ul>
                </div>
            </div>

        <!-- Coluna 3: Dados do Paciente -->
        <div class="col-md-4 paciente">
        <h3>Cadastro de Pacientes</h3>
        <form id="cadastroPaciente">
            <div class="form-group">
                <label for="cpf">CPF:</label>
                <input type="text" id="cpf" name="cpf" class="form-control" placeholder="Digite o CPF" required>
            </div>
            <button type="button" id="btnPesquisarpaciente" class="btn btn-primary">Pesquisar</button>
            <!-- Outros campos desativados -->
            <div class="form-group">
                <label for="nome">Nome:</label>
                <input type="text" id="nome" name="nome" class="form-control" placeholder="Nome" disabled>
            </div>
            
            <div class="form-group">
                <label for="data_nascimento">Data de Nascimento:</label>
                <input type="date" id="data_nascimento" name="data_nascimento" class="form-control"  disabled>

            </div>

            <div class="form-group">
                <label for="telefone">Telefone 1:</label>
                <input type="text" id="telefone1" name="telefone" class="form-control" placeholder="Telefone" disabled>
            </div>
            <div class="form-group">
                <label for="telefone">Telefone 2:</label>
                <input type="text" id="telefone2" name="telefone" class="form-control" placeholder="Telefone" disabled>
            </div>
            <div class="form-group">
                <label for="telefone">Telefone 3:</label>
                <input type="text" id="telefone3" name="telefone" class="form-control" placeholder="Telefone" disabled>
            </div>
            
        </form>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<!-- FullCalendar JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/lang/pt-br.js"></script>

<!-- Custom Script -->
<script>
 document.getElementById('especialidade').addEventListener('change', function() {
    var codespecialidade = this.value;

    if (codespecialidade) {
        // Fazendo a requisição para o backend passando o codespecialidade
        fetch(`/pesquisar_medico_especialidade/${codespecialidade}`)
            .then(response => response.json()) // Converte a resposta para JSON
            .then(data => {
                if (data) {
                   
                        var medicoSelect = document.getElementById('medico');
                        
                        // Limpa as opções anteriores
                        medicoSelect.innerHTML = '<option value="" disabled selected>Selecione um médico</option>';
                        
                        // Itera sobre os médicos retornados e preenche o dropdown
                        data.medicos.forEach(medico => {
                            var option = document.createElement('option');
                            option.value = medico.codmedico;  // código do médico
                            option.text = medico.nome;  // nome do médico
                            medicoSelect.add(option);
                        });
                    
                }
            })
            .catch(error => console.error('Erro ao buscar médicos:', error));
    }
});

 // Captura o clique no botão de pesquisa
 document.getElementById('btnPesquisarescala').addEventListener('click', function() {
        // Pega o médico selecionado
        var codmedico = document.getElementById('medico').value;

        // Verifica se um médico foi selecionado
        if (!codmedico) {
            alert("Selecione um médico");
            return;
        }

        fetch(`/buscar_escalas/${codmedico}`)
            .then(response => response.json())
            .then(data => {
                // Limpa a lista de datas de escalas antes de adicionar novas
                datasEscalas = []; 
              
                data.datas.forEach(escala => {
                    // Adiciona a data da escala à lista
                    test= new Date(escala.split(',')[1].trim())
                    datasEscalas.push(test.toISOString().split('T')[0]);
                    
               
                 
                    $('#calendar').fullCalendar('renderEvent', {
                        
                        title: 'Disponível',
                        start: escala.data, // Formatar a data corretamente
                        allDay: true,
                        backgroundColor: '#ff0000',
                        borderColor: '#28a745',
                        color: '#28a745' // Força a cor do texto e do fundo
                    }, true);
                 
                    abriraescala()
                    
                     // Atualiza o calendário
                  
                    $('#calendar').show(); 
                   
                });
             
                // Atualiza o calendário para aplicar as novas cores
                $('#calendar').fullCalendar('rerenderEvents');
                document.querySelector('.fc-next-button').click();
                document.querySelector('.fc-prev-button').click();
            })
            .catch(error => console.error('Erro ao buscar escalas:', error));
        });

document.getElementById('btnPesquisarpaciente').addEventListener('click', function(){
    var cpf = document.getElementById('cpf').value.replace(/\D/g, '');;
    fetch(`/pesquisar_paciente/${cpf}`)
            .then(response => response.json())
            .then(data => {
                if (data) {
                    if(data.flgencontrou){               
                        
                            document.getElementById('nome').value = data.nome;
                            document.getElementById('data_nascimento').value = data.data_nas;
                            document.getElementById('telefone1').value = data.telefone_01;
                            document.getElementById('telefone2').value = data.telefone_02;
                            document.getElementById('telefone3').value = data.telefone_03             

                    }
                }
            })
            .catch(error => console.error('Erro ao buscar escalas:', error));

});

document.getElementById('btnManha').addEventListener('click', function() {
 
    // Supondo que o valor de vagasManha é o número de horários disponíveis (por exemplo, 10 vagas)
    let vagasManha = 10; // Esse valor deve vir de algum lugar, pode ser uma variável ou input

    // Definindo o horário inicial (07:00)
    let horaAtual = new Date();
    horaAtual.setHours(7, 0, 0); // Inicia as 07:00

    // Obtendo o elemento onde os horários serão adicionados
    let listaHorarios = document.getElementById('listaHorarios');
    
    // Limpando a lista antes de adicionar novos horários
    listaHorarios.innerHTML = '';

    // Adicionando os horários para a manhã
    for (let i = 0; i < vagasManha; i++) {
        let horaFormatada = formatarHora(horaAtual); // Formata a hora no formato HH:MM
        let itemLista = document.createElement('li');
        itemLista.classList.add('list-group-item');
        itemLista.textContent = `${horaFormatada} --- Livre`;

        // Adiciona o item à lista
        listaHorarios.appendChild(itemLista);

        // Evento de duplo clique para marcar o horário como "Ocupado"
        itemLista.addEventListener('dblclick', function() {
            if (itemLista.textContent.includes('Livre')) {
                itemLista.textContent = `${horaFormatada} --- Ocupado`;
                itemLista.style.backgroundColor = '#f8d7da'; // Mudando cor de fundo para indicar "ocupado"
            }
        });

        horaAtual.setMinutes(horaAtual.getMinutes() + 30);

});
itemLista.addEventListener('dblclick', function() {
    if (itemLista.textContent.includes('Livre')) {
        itemLista.textContent = `${horaFormatada} --- Ocupado`;
        itemLista.style.backgroundColor = '#f8d7da'; // Mudando cor de fundo para indicar "ocupado"
    }
});

// Função para formatar a hora em HH:MM
function formatarHora(data) {
    let horas = data.getHours().toString().padStart(2, '0');
    let minutos = data.getMinutes().toString().padStart(2, '0');
    return `${horas}:${minutos}`;
}


document.getElementById('btnTarde').addEventListener('click',function(){
    alert('tarde')

});

document.getElementById('btnNoite').addEventListener('click',function(){
    alert('noite')

});

// Função para atualizar os horários com base no turno selecionado
function atualizaHorarios(turno) {
    // Limpar a lista atual de horários
    const lista = document.getElementById('listaHorarios');
    lista.innerHTML = '';

    // Obter a quantidade de vagas com base no turno selecionado
    let vagas;
    if (turno === 'manha') {
        vagas = document.getElementById('vagasManha').value;
    } else if (turno === 'tarde') {
        vagas = document.getElementById('vagasTarde').value;
    } else {
        vagas = document.getElementById('vagasNoite').value;
    }

    // Converter a quantidade de vagas para número
    vagas = Math.max(0, Math.min(5, parseInt(vagas))); // Limite de 0 a 5 para facilitar

    // Horários disponíveis
    const horariosDisponiveis = {
        manha: gerarHorarios(8, 30, vagas),  // 08:00 às 12:00
        tarde: gerarHorarios(13, 30, vagas), // 13:00 às 17:00
        noite: gerarHorarios(18, 30, vagas)   // 18:00 às 22:00
    };

    // Preencher a lista com os horários disponíveis
    const horariosSelecionados = horariosDisponiveis[turno];
    for (let i = 0; i < horariosSelecionados.length; i++) {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = `${horariosSelecionados[i]}: Livre`;
        lista.appendChild(li);
    }
}

// Função para gerar horários a partir de uma hora inicial, incremento e quantidade de horários
function gerarHorarios(inicio, incremento, quantidade) {
    const horarios = [];
    for (let i = 0; i < quantidade; i++) {
        const hora = inicio + Math.floor((i * incremento) / 60);
        const minuto = (i * incremento) % 60;
        const horaFormatada = `${String(hora).padStart(2, '0')}:${String(minuto).padStart(2, '0')}`;
        horarios.push(horaFormatada);
    }
    return horarios;
}


function abriraescala() {
     
        $('#calendar').fullCalendar({
            locale: 'pt-br',
            header: {
                left: 'prev,next',
                center: 'title',
                right: 'month today'
            },
            buttonText: {
                month: 'Mês',
                today: 'Hoje'
            },
            monthNames: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
            dayNamesShort: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'],
            selectable: true,
      
            dayClick: function(date, jsEvent, view) {
                var codmedico = document.getElementById('medico').value;
                buscarVagasPorData(date.format('YYYY-MM-DD'), codmedico);
                
            },
            dayRender: function(date, cell) {
             
              
               for (let i = 0; i < datasEscalas.length; i++) {
                    cell[0].offsetHeight;
                    if (date.format('YYYY-MM-DD') == datasEscalas[i]) {
                        cell.css("background-color", "green"); // Aplica a cor desejada
                        cell[0].offsetHeight;
                        break
                    }
                 }
                    
                        
             }
        });
        
        function buscarVagasPorData(data, codmedico) {
            // Faz a requisição para a rota que busca as vagas por data e médico
            fetch(`/buscar_vagas_por_data/${data}/${codmedico}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.message) {
                        document.getElementById('vagasManha').value = data.vagasManha || '0'; 
                        document.getElementById('vagasTarde').value = data.vagasTarde || '0'; 
                        document.getElementById('vagasNoite').value = data.vagasNoite || '0'; 
                    } else {
                        document.getElementById('vagasManha').value = '0'; 
                        document.getElementById('vagasTarde').value = '0'; 
                        document.getElementById('vagasNoite').value = '0'; 
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar vagas:', error);
                    alert('Ocorreu um erro ao buscar as vagas.');
                });
        }
        
    };
   
</script>



</body>
{% if mensagem %}
    <h4 class="text-danger text-center">{{ mensagem }}</h4>
{% endif %}

<script>
    function toggleConvenio(value) {
        const convenioSection = document.getElementById('convenio_section');
        convenioSection.style.display = value === 'sim' ? 'block' : 'none';
    }


    
</script>
{% endblock %}
